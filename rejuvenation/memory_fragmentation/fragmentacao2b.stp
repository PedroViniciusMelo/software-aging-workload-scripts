global alloc, fallback, fragmenting = 0, index = 0, print_count = 0
global who[100]

probe kernel.trace("mm_page_alloc_extfrag"){	
	if(who[execname(),pid(),pexecname(),ppid(),uid()] == 0){
		if(index == 100){  //o vetor encheu
			index = 0
			imprime_processos()
			delete who
			printf("\n\n>>> Vetor esvaziado\n\n,")
		}
		printf("Processo: %s(%d) / Pai: %s(%d) / UID: %d,", execname(),pid(),pexecname(),ppid(),uid())
		index++
	}
	who[execname(),pid(),pexecname(),ppid(),uid()]++
	alloc = $alloc_order
	fallback = $fallback_order	
	if(fallback<alloc){
		fragmenting++
	}
}

function imprime_processos() {
    printf("\n%s\n", ctime(gettimeofday_s()));
    printf("process; parent; UID; process_occurrences\n");
	foreach([process,pid,pexecname,ppid,uid] in who){
		printf("%s(%d); %s(%d); %d; %d\n", process,pid,pexecname,ppid,uid,who[process,pid,pexecname,ppid,uid]);
	}
}

//tempo a cada impressao dos valores
probe timer.s(30) {
	imprime_processos();
	printf("Ocorrencia: %d", fragmenting);
}

probe end{
    imprime_processos();
    printf("Ocorrencia: %d", fragmenting);
}

